from pymodbus.client import ModbusTcpClient as ModbusClient
import time
import sys 

#Data for connect to PLC (progamable logic controler)
PLC_IP = "163.172.68.42"
PLC_PORT = 10016
SLAVE_ID = 105

client = ModbusClient(host=PLC_IP, port=PLC_PORT, timeout=50)
res = client.connect()
if res:
    print(f"[INFO] Successfully connected to PLC on {PLC_IP}:{PLC_PORT}")
else:
    print("[ERROR] Failed to connect to PLC")
    sys.exit(1)

#Edit holding register at addr 0x10 and puting value 0xFF
try:
    write_result = client.write_register(0x10, 0xFF, slave=SLAVE_ID)  
    if write_result.isError():
        print("[x] error")
        client.close()
        exit()
    print("[+] Register Successfuly Written")
except Exception as e:
    print(f"[x] error : {e}")
    client.close()
    sys.exit(1)

time.sleep(0.5)

#Read Input registers
try:
    #125 => max value to avoid missing bytes, read input registers and return an array
    read_result = client.read_input_registers(address=0x10, count=125, slave=SLAVE_ID)
    if read_result.isError():
        print("[x] error while reading")
        client.close()
        sys.exit(1)
    else:
        print("[+] Data read: ")
        print(read_result.registers) 
except Exception as e:
    print(f"[x] error : {e}")

client.close()
